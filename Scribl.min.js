function Scribl(a,d){var b=a.getContext("2d");this.width=d;this.trackSizes=50;this.trackBuffer=5;this.offset=void 0;this.canvas=a;this.ctx=b;this.scale={};this.scale.pretty=!0;this.scale.max=void 0;this.scale.min=void 0;this.scale.auto=!0;this.scale.off=!1;this.scale.size=15;this.scale.font={};this.scale.font.size=15;this.scale.font.color="black";this.scale.font.buffer=4;this.glyph={};this.glyph.roundness=6;this.glyph.linearGradient=["#99CCFF","rgb(63, 128, 205)"];this.glyph.text={};this.glyph.text.color=
"black";this.glyph.text.size="13";this.glyph.text.font="arial";this.glyph.text.align="center";this.events={};this.events.hasClick=!1;this.events.hasMouseover=!1;this.events.clicks=[];this.events.mouseovers=[];this.events.added=!1;this.tick={};this.tick.auto=!0;this.tick.major={};this.tick.major.size=10;this.tick.major.color="black";this.tick.minor={};this.tick.minor.size=1;this.tick.minor.color="rgb(55,55,55)";this.tick.halfColor="rgb(10,10,10)";this.tooltips={};this.tooltips.text={};this.tooltips.text.font=
"arial";this.tooltips.text.size=12;this.tooltips.borderWidth=1;this.tooltips.roundness=5;this.tooltips.fade=!1;this.tooltips.style="light";var c=[];this.myMouseEventHandler=new MouseEventHandler(this);this.tracks=c;this.pixelsPerNt=function(b){return b==void 0?this.width/(this.scale.max-this.scale.min):b/(this.scale.max-this.scale.min)};this.ntsPerPixel=function(b){return b==void 0?1/this.pixelsPerNt():b/this.width};this.scale.trackSize=function(){return this.size+this.font.size};this.chartHeight=
function(){var b=0;b+=this.scale.trackSize();for(var a=0;a<this.tracks.length;a++)b+=this.trackBuffer,b+=this.tracks[a].getHeight();return b};this.addTrack=function(){var a=new track(b);a.chart=this;c.push(a);return a};this.loadGenbank=function(b){genbank(b,this)};this.loadFeatures=function(b){for(var a=0;a<b.length;a++)this.addFeature(b[a])};this.addGene=function(b,a,d){return this.addFeature(new BlockArrow("gene",b,a,d))};this.addProtein=function(b,a,d){return this.addFeature(new BlockArrow("protein",
b,a,d))};this.addFeature=function(b){var a,d=!0,c="this."+b.type;eval(c+" = {}");eval(c).text={};for(c=0;c<this.tracks.length;c++){var f=this.tracks[c].features[this.tracks[c].features.length-1];if(f!=void 0&&b.position-3/this.pixelsPerNt()>f.position+f.length){d=!1;a=this.tracks[c];break}}d&&(a=this.addTrack());a.addFeature(b);return b};this.slice=function(b,a){for(var d=[],c=0;c<this.tracks.length;c++)for(var f=this.tracks[c].features,g=0;g<f.length;g++){var e=f[g].position+f[g].length,m=f[g].position;
m>=b&&m<=a?d.push(f[g]):e>b&&e<a?d.push(f[g]):m<b&&e>a?d.push(f[g]):m>b&&e<a&&d.push(f[g])}c=new Scribl(this.canvas,this.width);c.loadFeatures(d);return c};this.delayed_draw=function(b){b.ctx.clearRect(0,0,b.canvas.width,b.canvas.height);b.draw()};this.zoom=function(b,a,d,c,f,g){for(var e=void 0,m=0;b!=d||a!=c;){e=this.slice(b,a);e.scale.off=!0;e.scale.auto=!1;e.scale.min=b;e.scale.max=a;e.scale.pretty=!1;m+=f;setTimeout(this.delayed_draw,m,e);var n=e.ntsPerPixel(a-c)*g;e=e.ntsPerPixel(b-d)*g;Math.abs(e)<
0.05?b=d:b-=e;Math.abs(n)<0.05?a=c:a-=n}e=this.slice(d,c);e.scale.max=c;e.scale.min=d;e.tick.major.size=1E3;setTimeout(this.delayed_draw,m+1,e)};this.draw=function(){b.save();if(this.scale.pretty){if(this.tick.auto)this.tick.major.size=this.determineMajorTick(),this.tick.minor.size=this.tick.major.size/10;if(this.scale.auto)this.scale.min-=this.scale.min%this.tick.major.size,this.scale.max=Math.round(this.scale.max/this.tick.major.size+0.4)*this.tick.major.size}this.offset=this.scale.min.offset?b.measureText(this.getTickText(this.scale.min)).width/
2+10:b.measureText("0").width/2+10;b.translate(this.offset,0);var a=this.scale.font.size+this.scale.size,d=this.scale.font.size+2,i=this.scale.font.size+this.scale.size*0.66,j=this.scale.font.size+this.scale.size*0.33;b.save();b.translate(-this.scale.min*this.pixelsPerNt(),0);b.font=this.scale.font.size+"px arial";b.textBaseline="top";var f=b.fillStyle;b.fillStyle=this.scale.font.color;if(!this.scale.off)for(var g=this.scale.min;g<=this.scale.max;g++){var e=g*this.pixelsPerNt();b.beginPath();if(g%
this.tick.major.size==0){var m=this.getTickText(g);b.textAlign="center";b.fillText(m,e,0);b.moveTo(e,a);b.lineTo(e,d);b.strokeStyle=this.tick.major.color;b.stroke()}else if(g%this.tick.minor.size==0)b.moveTo(e,a),g%(this.tick.major.size/2)==0?(b.strokeStyle=this.tick.halfColor,b.lineTo(e,j)):(b.strokeStyle=this.tick.minor.color,b.lineTo(e,i)),b.stroke()}b.fillStyle=f;b.save();a=this.scale.trackSize()+this.trackBuffer;b.translate(0,this.scale.trackSize()+this.trackBuffer);for(g=0;g<c.length;g++)c[g].y=
a,c[g].draw(),b.translate(0,c[g].getHeight()+this.trackBuffer),a=a+c[g].getHeight()+this.trackBuffer;b.restore();b.restore();b.restore();this.events.added||this.registerEventListeners()};this.redraw=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.tracks.length>0&&this.draw()};this.determineMajorTick=function(){this.ctx.font=this.scale.font.size+"px arial";var a=this.width/(b.measureText(this.getTickText(this.scale.max)).width+this.scale.font.buffer);this.tick.major.size*=
Math.round((this.scale.max-this.scale.min)/a/this.tick.major.size+0.4);digits=(this.tick.major.size+"").length;places=Math.pow(10,digits);first_digit=this.tick.major.size/places;first_digit>0.1&&first_digit<=0.5?first_digit=0.5:first_digit>0.5&&(first_digit=1);return first_digit*places};this.getTickText=function(b){if(!this.tick.auto)return b;var a=b;b>=1E6?a=a/1E6+"m":b>=1E3&&(a=a/1E3+"k");return a};this.handleMouseEvent=function(b,a){this.myMouseEventHandler.setMousePosition(b);this.redraw();if(a==
"click")var d=this.events.clicks,c=0;else d=this.events.mouseovers,c=0;for(;c<d.length;c++)d[c](this);this.myMouseEventHandler.reset(this)};this.addClickEventListener=function(b){this.events.clicks.push(b)};this.addMouseoverEventListener=function(b){this.events.mouseovers.push(b)};this.registerEventListeners=function(){var b=this;this.events.mouseovers.length>0&&this.canvas.addEventListener("mousemove",function(a){b.handleMouseEvent(a,"mouseover")},!1);this.events.clicks.length>0&&this.canvas.addEventListener("click",
function(a){b.handleMouseEvent(a,"click")},!1);this.events.added=!0}}
function track(){this.height=void 0;this.features=[];this.addGene=function(a,d,b){return this.addFeature(new BlockArrow("gene",a,d,b))};this.addProtein=function(a,d,b){return this.addFeature(new BlockArrow("protein",a,d,b))};this.addFeature=function(a){a.track=this;this.features.push(a);if(a.length+a.position>this.chart.scale.max||this.chart.scale.max==void 0)this.chart.scale.max=a.length+a.position;if(a.position<this.chart.scale.min||this.chart.scale.min==void 0)this.chart.scale.min=a.position;return a};
this.getHeight=function(){return this.height!=void 0?this.height:this.chart.trackSizes};this.draw=function(){for(var a=0;a<this.features.length;a++)this.features[a].draw()}}
(function(){var a=!1,d=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(b){function c(){!a&&this.init&&this.init.apply(this,arguments)}var l=this.prototype;a=!0;var k=new this;a=!1;for(var i in b)k[i]=typeof b[i]=="function"&&typeof l[i]=="function"&&d.test(b[i])?function(b,a){return function(){var d=this._super;this._super=l[b];var c=a.apply(this,arguments);this._super=d;return c}}(i,b[i]):b[i];c.prototype=k;c.constructor=c;c.extend=arguments.callee;return c}})();function MouseEventHandler(a){this.chart=a;this.mouseY=this.mouseX=null;this.eventElement=void 0;this.isEventDetected=!1;this.tooltip=new tooltips(this.chart);this.addEvents=function(d){var b=this.chart.ctx,c=a.myMouseEventHandler;if(d.onMouseover&&!a.events.hasMouseover)a.addMouseoverEventListener(a.myMouseEventHandler.handleMouseover),a.events.hasMouseover=!0;if(d.onClick&&!a.events.hasClick)a.addClickEventListener(a.myMouseEventHandler.handleClick),a.addMouseoverEventListener(a.myMouseEventHandler.handleMouseStyle),
a.events.hasClick=!0;if(!c.isEventDetected&&b.isPointInPath_mozilla(c.mouseX,c.mouseY))c.eventElement=d,c.isEventDetected=!0};this.setMousePosition=function(a){if(a!=null){var b=this.chart.canvas.getBoundingClientRect();this.mouseX=a.clientX-b.left;this.mouseY=a.clientY-b.top}};this.handleClick=function(a){a=a.myMouseEventHandler.eventElement;a!=void 0&&a.onClick!=void 0&&window.open(a.onClick)};this.handleMouseover=function(a){a=a.myMouseEventHandler;var b=a.eventElement;b!=void 0&&b.onMouseover!=
void 0&&a.tooltip.fire(b)};this.handleMouseStyle=function(a){var b=a.myMouseEventHandler.eventElement;a.ctx.canvas.style.cursor=b==void 0||b.onClick==void 0?"auto":"pointer"};this.reset=function(a){a=a.myMouseEventHandler;a.mouseX=null;a.mouseY=null;a.eventElement=void 0;a.isEventDetected=null;a.elementIndexCounter=0}}
function tooltips(a){this.chart=a;this.ctx=a.ctx;this.fire=function(a){var b=this.ctx.globalAlpha;this.chart.tooltips.fade?h=1:this.draw(a,1);this.ctx.globalAlpha=b};this.draw=function(a,b){this.ctx.globalAlpha=b;var c=this.chart.tooltips.roundness,l=this.chart.tooltips.text.font,k=this.chart.tooltips.text.size;this.ctx.save();this.ctx.font=k+"px "+l;l=this.ctx.measureText(a.onMouseover);k+=10;var i=l.width+10,j=k-4,f,g,e=a.pixelPosition_x()+10;j=a.pixelPosition_y()-j;if(this.chart.tooltips.style==
"light")f=this.chart.ctx.createLinearGradient(e+i/2,j,e+i/2,j+k),f.addColorStop(0,"rgb(253, 248, 196)"),f.addColorStop(0.75,"rgb(253, 248, 196)"),f.addColorStop(1,"white"),g=this.chart.ctx.createLinearGradient(e+i/2,j,e+i/2,j+k),g.addColorStop(0,"black"),g.addColorStop(1,"rgb(64, 64, 64)"),this.chart.tooltips.text.color="black";else if(this.chart.tooltips.style=="dark")f=this.chart.ctx.createLinearGradient(e+i/2,j,e+i/2,j+k),f.addColorStop(0,"rgb(64, 64, 64)"),f.addColorStop(1,"rgb(121, 121, 121)"),
g="white",this.chart.tooltips.text.color="white";this.ctx.fillStyle=f;this.ctx.beginPath();tlc_ctrl_x=e;tlc_ctrl_y=j;tlc_lgth_x=e+c;tlc_lgth_y=j;tlc_wdth_x=e;tlc_wdth_y=j+c;blc_ctrl_x=e;blc_ctrl_y=j+k;blc_lgth_x=e+c;blc_lgth_y=j+k;blc_wdth_x=e;blc_wdth_y=j+k-c;brc_ctrl_x=e+i;brc_ctrl_y=j+k;brc_lgth_x=e+i-c;brc_lgth_y=j+k;brc_wdth_x=e+i;brc_wdth_y=j+k-c;trc_ctrl_x=e+i;trc_ctrl_y=j;trc_lgth_x=e+i-c;trc_lgth_y=j;trc_wdth_x=e+i;trc_wdth_y=j+c;this.ctx.moveTo(tlc_lgth_x,tlc_lgth_y);this.ctx.quadraticCurveTo(tlc_ctrl_x,
tlc_ctrl_y,tlc_wdth_x,tlc_wdth_y);this.ctx.lineTo(blc_wdth_x,blc_wdth_y);this.ctx.quadraticCurveTo(blc_ctrl_x,blc_ctrl_y,blc_lgth_x,blc_lgth_y);this.ctx.lineTo(brc_lgth_x,brc_lgth_y);this.ctx.quadraticCurveTo(brc_ctrl_x,brc_ctrl_y,brc_wdth_x,brc_wdth_y);this.ctx.lineTo(trc_wdth_x,trc_wdth_y);this.ctx.quadraticCurveTo(trc_ctrl_x,trc_ctrl_y,trc_lgth_x,trc_lgth_y);this.ctx.lineTo(tlc_lgth_x,tlc_lgth_y);this.ctx.fill();this.ctx.lineWidth=this.chart.tooltips.borderWidth;this.ctx.strokeStyle=g;this.ctx.stroke();
this.ctx.textBaseline="middle";this.ctx.fillStyle=this.chart.tooltips.text.color;this.ctx.fillText(a.onMouseover,e+i/2-l.width/2,j+k/2);this.ctx.restore()}}CanvasRenderingContext2D.prototype.isPointInPath_mozilla=function(a,d){if(navigator.userAgent.indexOf("Firefox")!=-1){this.save();this.setTransform(1,0,0,1,0,0);var b=this.isPointInPath(a,d);this.restore()}else b=this.isPointInPath(a,d);return b};var Glyph=Class.extend({init:function(a,d,b,c){this.position=d;this.length=b;this.strand=c;this.type=a;this.name="";this.font={};this.font.style=void 0;this.font.size=void 0;this.font.color=void 0;this.font.align=void 0},pixelLength:function(){return this.length*this.track.chart.pixelsPerNt()||1},pixelPosition_x:function(){return this.position*this.track.chart.pixelsPerNt()},pixelPosition_y:function(){return this.track.y},setTextOptions:function(){var a="this.track.chart."+this.type;if(this.font.style==
void 0&&this.track.chart.glyph.text.font!=void 0)this.font.style=this.track.chart.glyph.text.font;else if(eval(a).text.style!=void 0)this.font.style=eval(a).text.font;if(this.font.size==void 0&&this.track.chart.glyph.text.size!=void 0)this.font.size=this.track.chart.glyph.text.size;else if(eval(a).text.size!=void 0)this.font.size=eval(a).text.size;if(this.font.color==void 0&&this.track.chart.glyph.text.color!=void 0)this.font.color=this.track.chart.glyph.text.color;else if(eval(a).text.color!=void 0)this.font.color=
eval(a).text.color;if(this.font.align==void 0&&this.track.chart.glyph.text.align!=void 0)this.font.align=this.track.chart.glyph.text.align;else if(eval(a).text.align!=void 0)this.font.align=eval(a).text.align},drawText:function(a){var d=this.track.chart.ctx,b=this.pixelLength(),c=this.getHeight();d.font=this.font.size+"px "+this.font.style;d.textBaseline="middle";d.fillStyle=this.font.color;var l=void 0;if(this.font.align=="start")this.font.align=this.strand=="+"?"left":"right";else if(this.font.align==
"end")this.font.align=this.strand=="+"?"right":"left";d.textAlign=this.font.align;d.textAlign=="left"?l=5:d.textAlign=="center"?l=b/2:d.textAlign=="right"&&(l=b-5);d.measureText(a);a!=""&&d.fillText(a,l,c/2)},getRoundness:function(){var a;a="this.track.chart."+this.type;a=this.roundness!=void 0?this.roundness:eval(a)!=void 0&&eval(a).roundness!=void 0?eval(a).roundness:this.track.chart.glyph.roundness;return this.getHeight()*a/100},getHeight:function(){return this.track.getHeight()},getFillStyle:function(){var a;
a="this.track.chart."+this.type;if(this.color!=void 0)a=this.color;else if(eval(a).color!=void 0)a=eval(a).color;else if(eval(a).linearGradient!=void 0){for(var d=this.ctx.createLinearGradient(this.length/2,0,this.length/2,this.getHeight()),b=0;b<eval(a).linearGradient.length;b++){var c=b/(eval(a).linearGradient.length-1);d.addColorStop(c,eval(a).linearGradient[b])}a=d}else if(this.track.chart.glyph.color!=void 0)a=this.track.chart.glyph.color;else{d=this.ctx.createLinearGradient(this.length/2,0,
this.length/2,this.getHeight());for(b=0;b<this.track.chart.glyph.linearGradient.length;b++)c=b/(this.track.chart.glyph.linearGradient.length-1),d.addColorStop(c,this.track.chart.glyph.linearGradient[b]);a=d}return a},draw:function(){this.setTextOptions();this.ctx=this.track.chart.ctx;/^\d+/.exec(this.ctx.font);var a=/\S+$/.exec(this.ctx.font);this.ctx.fillStyle=this.getFillStyle();var d=this.ctx.fillStyle,b=this.pixelPosition_x(),c=this.getHeight();c<10?this.ctx.font="10px "+a:this.ctx.font=c*0.9+
"px "+a;this.ctx.translate(b,0);this.strand=="-"&&this.ctx.transform(-1,0,0,1,this.pixelLength(),0);this._draw();this.strand=="-"&&this.ctx.transform(-1,0,0,1,this.pixelLength(),0);this.drawText(this.name);this.ctx.translate(-b,0);this.ctx.fillStyle=d;this.track.chart.myMouseEventHandler.addEvents(this)}});var BlockArrow=Glyph.extend({init:function(a,d,b,c){this._super(a,d,b,c);this.slope=1;this.name=""},_draw:function(){var a=this.pixelLength(),d=this.getHeight(),b=this.getRoundness();tc_ctrl_y=tc_ctrl_x=x=y=0;tc_lgth_x=x+b;tc_lgth_y=y;tc_wdth_x=x;tc_wdth_y=y+b;bc_ctrl_x=x;bc_ctrl_y=y+d;bc_lgth_x=x+b;bc_lgth_y=y+d;bc_wdth_x=x;bc_wdth_y=y+d-b;a_b_x=x+a-b;a_t_x=x+a-b;a_max_x=x+a;t=0.5;a_ctrl_x=(a_max_x-(1-t)*(1-t)*a_b_x-t*t*a_t_x)/(2*(1-t)*t);a_ctrl_y=y+d/2;bs_slope=this.slope;bs_intercept=-a_ctrl_y-
bs_slope*a_ctrl_x;ts_slope=-this.slope;ts_intercept=-a_ctrl_y-ts_slope*a_ctrl_x;a_b_y=-(bs_slope*a_b_x+bs_intercept);a_t_y=-(ts_slope*a_t_x+ts_intercept);bs_ctrl_y=y+d;bs_ctrl_x=(-bs_ctrl_y-bs_intercept)/this.slope;bs_ctrl_x<x?(new Rect("gene",0,a))._draw(this.ctx,a,d,b):(bs_lgth_y=y+d,bs_lgth_x=bs_ctrl_x-b,bs_slpe_x=bs_ctrl_x+b,bs_slpe_y=-(bs_slope*bs_slpe_x+bs_intercept),ts_ctrl_y=y,ts_ctrl_x=(ts_ctrl_y+ts_intercept)/this.slope,ts_lgth_y=y,ts_lgth_x=ts_ctrl_x-b,ts_slpe_x=ts_ctrl_x+b,ts_slpe_y=-(ts_slope*
ts_slpe_x+ts_intercept),this.ctx.beginPath(),this.ctx.moveTo(tc_lgth_x,tc_lgth_y),this.ctx.quadraticCurveTo(tc_ctrl_x,tc_ctrl_y,tc_wdth_x,tc_wdth_y),this.ctx.lineTo(bc_wdth_x,bc_wdth_y),this.ctx.quadraticCurveTo(bc_ctrl_x,bc_ctrl_y,bc_lgth_x,bc_lgth_y),this.ctx.lineTo(bs_lgth_x,bs_lgth_y),this.ctx.quadraticCurveTo(bs_ctrl_x,bs_ctrl_y,bs_slpe_x,bs_slpe_y),this.ctx.lineTo(a_b_x,a_b_y),this.ctx.quadraticCurveTo(a_ctrl_x,a_ctrl_y,a_t_x,a_t_y),this.ctx.lineTo(ts_slpe_x,ts_slpe_y),this.ctx.quadraticCurveTo(ts_ctrl_x,
ts_ctrl_y,ts_lgth_x,ts_lgth_y),this.ctx.lineTo(tc_lgth_x,tc_lgth_y),this.ctx.fill())}});var Rect=Glyph.extend({init:function(a,d,b){this._super(a,d,b,"+")},_draw:function(a,d,b,c){a=a||this.ctx;d=d||this.pixelLength();b=b||this.getHeight();c=c+1||this.getRoundness();c!=void 0&&(c-=1);x=y=0;a.beginPath();tlc_ctrl_x=x;tlc_ctrl_y=y;tlc_lgth_x=x+c;tlc_lgth_y=y;tlc_wdth_x=x;tlc_wdth_y=y+c;blc_ctrl_x=x;blc_ctrl_y=y+b;blc_lgth_x=x+c;blc_lgth_y=y+b;blc_wdth_x=x;blc_wdth_y=y+b-c;brc_ctrl_x=x+d;brc_ctrl_y=y+b;brc_lgth_x=x+d-c;brc_lgth_y=y+b;brc_wdth_x=x+d;brc_wdth_y=y+b-c;trc_ctrl_x=x+d;trc_ctrl_y=
y;trc_lgth_x=x+d-c;trc_lgth_y=y;trc_wdth_x=x+d;trc_wdth_y=y+c;a.moveTo(tlc_lgth_x,tlc_lgth_y);a.quadraticCurveTo(tlc_ctrl_x,tlc_ctrl_y,tlc_wdth_x,tlc_wdth_y);a.lineTo(blc_wdth_x,blc_wdth_y);a.quadraticCurveTo(blc_ctrl_x,blc_ctrl_y,blc_lgth_x,blc_lgth_y);a.lineTo(brc_lgth_x,brc_lgth_y);a.quadraticCurveTo(brc_ctrl_x,brc_ctrl_y,brc_wdth_x,brc_wdth_y);a.lineTo(trc_wdth_x,trc_wdth_y);a.quadraticCurveTo(trc_ctrl_x,trc_ctrl_y,trc_lgth_x,trc_lgth_y);a.lineTo(tlc_lgth_x,tlc_lgth_y);a.fill()}});function genbank(a,d){for(var b=a.split("\n"),c=RegExp(/\s+gene\s+([a-z]*)\(?(\d+)\.\.(\d+)/),l=[],k=void 0,i=void 0,j=0;j<b.length;j++){var f;if(f=b[j].match(c)){f.shift();l.push(f);var g=f[2];if(k==void 0||k>g)k=g;f=f[1];if(i==void 0||i<f)i=f}}d.scale.max=k;d.scale.min=i;for(b=0;b<l.length;b++)c="+",l[b][0]=="complement"&&(c="-"),f=l[b][1],g=l[b][2],f=f-1+1,d.addGene(f,g-f,c)};
